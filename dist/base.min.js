"use strict";var res=void 0,tag_list={};window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(t){var e=+new Date,i=Math.max(0,16-(e-lastTime)),n=window.setTimeout(function(){t(e+i)},i);return lastTime=e+i,n};var loadFile=function(t,e){if("function"!=typeof fetch){var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status){var t=void 0;try{t=JSON.parse(i.responseText)}catch(e){t={},console.warn(e)}e(t)}else console.warn("Error",i.statusText)},i.open("GET",t,!0),i.send()}else fetch(t).then(function(t){return t.json()}).then(function(t){return e(t)})},easeInOutCubic=function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},animate=function(t,e,i,n,o){if(t&&t[e]&&!(n<100)){var a=t[e],s=i-a,r=null;requestAnimationFrame(function i(c){null===r&&(r=c);var d=c-r;t[e]=a+o(d/n)*s,d<n&&requestAnimationFrame(i)})}},isMobile=function(){return navigator.userAgent.match(/Android|iPhone|iPod|Opera Mini|webOS|Windows Phone|IEMobile|BlackBerry/i)};document.getElementById("totop").addEventListener("click",function(){animate(document.body,"scrollTop",0,1e3,easeInOutCubic)}),isMobile()&&(document.getElementById("close").parentNode.className="",document.getElementById("close").addEventListener("click",function(t){t.target.parentNode.className="hidden"})),loadFile("./dist/gallery_info.json",function(t){console.log(t.name+": "+t.description),console.log("Author: "+t.author);for(var e=t.content.length,i=void 0,n=0;n<e;n++)!function(e){var i=Math.floor(t.content[e].date/1e4);i<=2012&&(i="~2012"),tag_list[i+=""]?tag_list[i].push(e):tag_list[i]=[e],t.content[e].tags.forEach(function(t){tag_list[t]?tag_list[t].push(e):tag_list[t]=[e]})}(n);i=Object.keys(tag_list);var o={template:'<div id="photos" @click="changeView($event)">        <Column v-for="(items, index) in itemsForColumns" :items="items" :id="index">      </div>',data:function(){return{columns:Math.floor(document.body.clientWidth/266),lastFlag:5*Math.floor(document.body.clientWidth/266)-1}},props:["factors"],methods:{changeView:function(t){+t.target.parentNode.id&&this.$emit("toinfo",t.target.parentNode.id)},handleScroll:function(t){var e=this;if(!(this.items.length<=this.lastFlag)){for(var i=-1,n=0;n<this.columns;n++){var o=document.getElementById("wall-"+n);o&&o.offsetTop+o.clientHeight-20<t+(window.innerHeight||document.documentElement.clientHeight)&&(i=n)}++i&&(this.lastFlag+=i,setTimeout(function(){e.handleScroll(t)},0))}}},computed:{items:function(){var n=[],o={},a=Array.apply(null,Array(e)).map(function(t,e){return e}),s=void 0;this.factors.forEach(function(t){s=i.filter(function(e){return-1!=e.search(t)}).reduce(function(t,e){return t.concat(tag_list[e])},[]),a=_.intersection(s,a)});for(var r=a.length-1;r>=0;r--)void 0==o[a[r]]&&(o[a[r]]=1,n.push({id:a[r],desc:t.content[a[r]].info,path:"./assets/img/"+a[r]+"."+t.content[a[r]].type}));return n},itemsForColumns:function(){var t=this,e=Array.apply(null,Array(this.columns)).map(function(){return[]});return this.items.slice(0,this.lastFlag+1).forEach(function(i,n){e[n%t.columns].push(i)}),e}},watch:{items:function(){this.lastFlag=5*Math.floor(document.body.clientWidth/266)-1}},mounted:function(){var t=this;window.addEventListener("scroll",function(e){var i=document.body.scrollTop,n=document.getElementById("totop");n.className=i?"":"hidden",t.handleScroll(i)}),window.addEventListener("resize",function(e){t.columns=Math.floor(document.body.clientWidth/266),t.lastFlag=Math.max(5*t.columns-1,t.lastFlag)})},components:{Column:{template:'<div class="wall-column" :id="`wall-${id}`">      <figure v-for="item in items" :id="item.id">        <img :src="item.path">        <aside><span>{{item.desc}}</span></aside>      </figure>    </div>',props:["items","id"]}}},a={template:'<div id="display">      <aside @click="quit">×</aside>      <figure><img :src="path"></figure>      <div id="imginfo">        <p><span class="vertical-center img-intro">{{info}}</span></p>        <div id="imgtags" @click="chooseTag($event)">          <span v-for="tag in tags">{{tag}}</span>        </div>        <div id="imgrelated" class="clearfix" @click="choosePic($event)">          <div>相似的图片：</div>          <img v-for="relate in relates" :src="relate.path" :id="relate.id">        </div>      </div>    </div>',props:["pid"],data:function(){return{id:this.pid}},methods:{chooseTag:function(t){this.$emit("revisetag",t.target.innerText)},choosePic:function(t){var e=parseInt(t.target.id);e>=0&&(this.id=e)},quit:function(){this.$emit("revisetag")}},computed:{path:function(){return"./assets/img/"+this.id+"."+t.content[this.id].type},info:function(){return t.content[this.id].info},tags:function(){return t.content[this.id].tags},relates:function(){for(var e=this.tags,i=[parseInt(this.id)],n=0;n<4;n++){for(var o=tag_list[e[_.random(e.length-1)]],a=_.random(o.length-1),s=0;-1!=i.indexOf(o[a]);)if(o=tag_list[e[_.random(e.length-1)]],a=_.random(o.length-1),++s>20)return i.shift(),i.map(function(e){return"./assets/img/"+e+"."+t.content[e].type});i.push(o[a])}return i.shift(),i.map(function(e){return{path:"./assets/img/"+e+"."+t.content[e].type,id:e}})}}};new Vue({data:{filter:"",pid:0,currView:"picwall",index:-1},mounted:function(){var t=this;document.getElementById("navbar").addEventListener("click",function(e){var i=e.target.className,n=+e.target.id;"list-unit"===i?t.addTag(e):~i.indexOf("list-item")&&t.index!==n?t.modifyIndex(n):t.modifyIndex(-1),e.stopPropagation()}),window.addEventListener("click",function(){t.modifyIndex(-1)})},methods:{addPreface:function(){""==this.filter&&(this.filter="preface"),-1==this.factors.indexOf("preface")&&(this.filter+=",preface")},addShot:function(){""==this.filter&&(this.filter="screenshot"),-1==this.factors.indexOf("screenshot")&&(this.filter+=",screenshot")},addTag:function(t){var e=t.target.dataset.tag;""==this.filter&&(this.filter=e),-1==this.factors.indexOf(e)&&(this.filter+=","+e)},toInfo:function(t){t&&(this.pid=t),this.currView="picinfo"},reviseTag:function(t){t?this.filter=t:this.currView="picwall"},modifyIndex:function(t){this.index=t}},computed:{factors:function(){return this.filter.split(",",10).filter(function(t){return""!=t})}},watch:{filter:function(){this.currView="picwall",this.index=-1},currView:function(t){document.body.className="picinfo"===t?"noscroll":""}},components:{picwall:o,picinfo:a}}).$mount("#app")});